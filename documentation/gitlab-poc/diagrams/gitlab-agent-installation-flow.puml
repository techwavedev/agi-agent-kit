@startuml gitlab-agent-installation-flow
' ============================================================================
' GitLab Agent Installation Flow - Sequence Diagram
' ============================================================================
' Purpose: Step-by-step installation sequence for EKS integration
' Usage: plantuml -tpng gitlab-agent-installation-flow.puml
' ============================================================================

skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam roundCorner 8
skinparam shadowing false
skinparam sequenceMessageAlign center

' Colors
skinparam participant {
    BackgroundColor #E24329
    FontColor white
}

skinparam actor {
    BackgroundColor #4CAF50
}

title **GitLab Agent Installation Flow**\n<size:10>Complete step-by-step installation sequence</size>

' ============================================================================
' PARTICIPANTS
' ============================================================================
actor "DevOps\nEngineer" as engineer #4CAF50
participant "Terminal" as terminal #4CAF50
participant "GitLab UI\nsdlc.webcloud..." as gitlab #E24329
participant "Helm" as helm #0F1689
participant "EKS\nCluster" as eks #FF9900
participant "Agent\nPod" as agent #6B4FBB
participant "KAS" as kas #E24329

' ============================================================================
' PHASE 1: REGISTER AGENT
' ============================================================================
== **Phase 1: Register Agent in GitLab UI** ==

engineer -> gitlab : 1. Navigate to Project
activate gitlab
gitlab -> gitlab : Operate → Kubernetes clusters\n→ Connect a cluster
engineer -> gitlab : 2. Enter agent name:\n"eks-nonprod-agent"
gitlab -> gitlab : Generate registration token
gitlab --> engineer : 3. Display token\n**⚠️ SAVE NOW!**
note right
  Token shown only once!
  Store securely.
end note
deactivate gitlab

' ============================================================================
' PHASE 2: HELM SETUP
' ============================================================================
== **Phase 2: Add Helm Repository** ==

engineer -> terminal : Open terminal
activate terminal
terminal -> terminal : helm repo add gitlab\nhttps://charts.gitlab.io
terminal -> terminal : helm repo update
terminal --> engineer : Repository ready ✓
deactivate terminal

' ============================================================================
' PHASE 3: INSTALL AGENT
' ============================================================================
== **Phase 3: Install Agent on EKS** ==

engineer -> eks : 4. Verify cluster access\nkubectl cluster-info
activate eks
eks --> engineer : Cluster accessible ✓

engineer -> helm : 5. Install agent via Helm
activate helm
note right of helm
  helm upgrade --install gitlab-agent \
    gitlab/gitlab-agent \
    --namespace gitlab-agent \
    --create-namespace \
    --set config.token=<TOKEN> \
    --set config.kasAddress=wss://kas.sdlc...
end note

helm -> eks : Create namespace & deploy
eks -> agent : Pod starts
activate agent

agent -> kas : 6. Connect to GitLab (gRPC)
activate kas
kas --> agent : Connected ✓
note over agent,kas #E8F5E9
  **Connection Established!**
  Outbound from cluster
end note
deactivate kas
deactivate helm
deactivate eks

' ============================================================================
' PHASE 4: CONFIGURE
' ============================================================================
== **Phase 4: Configure Agent** ==

engineer -> terminal : 7. Create agent config
activate terminal
note right
  .gitlab/agents/eks-nonprod-agent/config.yaml
  ---
  ci_access:
    projects:
      - id: apim/poc-aws-shared
        default_namespace: poc-nginx-test
end note

terminal -> gitlab : git add & push
activate gitlab
gitlab --> terminal : Config received ✓
deactivate gitlab
deactivate terminal

' ============================================================================
' PHASE 5: UPDATE PIPELINE
' ============================================================================
== **Phase 5: Update CI/CD Pipeline** ==

engineer -> terminal : 8. Edit .gitlab-ci.yml
activate terminal
note right
  variables:
    KUBE_CONTEXT: "apim/poc-aws-shared:eks-nonprod-agent"
end note

terminal -> gitlab : git push
activate gitlab
gitlab -> kas : Pipeline runs
kas -> agent : Send kubectl command
agent -> eks : kubectl apply -k k8s/base
activate eks
eks --> agent : Resources created ✓
agent --> kas : Success
kas --> gitlab : Job passed ✓
gitlab --> engineer : **Pipeline Passed!** ✅
deactivate eks
deactivate gitlab
deactivate terminal
deactivate agent

' ============================================================================
' PHASE 6: VERIFY
' ============================================================================
== **Phase 6: Verification** ==

engineer -> eks : 9. Verify all resources
activate eks
note right
  kubectl get pods -n gitlab-agent
  kubectl get pods -n poc-nginx-test
  kubectl logs -n gitlab-agent -l app=gitlab-agent
end note
eks --> engineer : All running ✓
deactivate eks

note over engineer #C8E6C9
  **Installation Complete!**
end note

footer \n**Total Steps:** 9 | **Time:** ~15 minutes
@enduml
