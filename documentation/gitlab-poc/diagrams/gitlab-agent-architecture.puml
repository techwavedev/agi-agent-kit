@startuml gitlab-agent-architecture
' ============================================================================
' GitLab Agent for Kubernetes - EKS Architecture Diagram
' ============================================================================
' Purpose: Show the complete architecture of GitLab Agent integration with EKS
' Usage: plantuml -tpng gitlab-agent-architecture.puml
' ============================================================================

skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam roundCorner 8
skinparam shadowing false

' Colors
skinparam component {
    BackgroundColor<<gitlab>> #E24329
    FontColor<<gitlab>> white
    BackgroundColor<<agent>> #6B4FBB
    FontColor<<agent>> white
    BackgroundColor<<k8s>> #326CE5
    FontColor<<k8s>> white
    BackgroundColor<<helm>> #0F1689
    FontColor<<helm>> white
    BackgroundColor<<aws>> #FF9900
    FontColor<<aws>> white
}

skinparam cloud {
    BackgroundColor #FFF8E1
    BorderColor #FF9800
}

skinparam rectangle {
    BackgroundColor #F5F5F5
    BorderColor #9E9E9E
}

title **GitLab Agent for Kubernetes - EKS Architecture**\n<size:10>POC: EC GitLab → EKS Non-Prod Cluster</size>

' ============================================================================
' LEGEND
' ============================================================================
legend right
  |= Color |= Component |
  | <#E24329> | GitLab Components |
  | <#6B4FBB> | GitLab Agent |
  | <#326CE5> | Kubernetes Resources |
  | <#FF9900> | AWS Infrastructure |
endlegend

' ============================================================================
' EC GITLAB INSTANCE
' ============================================================================
cloud "EC GitLab Instance" as gitlab_cloud #FFF3E0 {
    rectangle "sdlc.webcloud.ec.europa.eu" as gitlab_url <<gitlab>> {
        component "**GitLab KAS**\n(Kubernetes Agent Server)" as kas <<gitlab>>
        component "**Project Repository**\napim/poc-aws-shared" as repo <<gitlab>>
        
        rectangle "Project Files" as proj_struct #FFFFFF {
            file ".gitlab-ci.yml" as ci_file
            file ".gitlab/agents/\n<agent-name>/\nconfig.yaml" as agent_config
            folder "k8s/base/" as k8s_manifests
        }
    }
}

' ============================================================================
' AWS CLOUD
' ============================================================================
rectangle "**AWS Cloud**" as aws_cloud #E3F2FD {
    
    rectangle "VPC - Non-Production" as vpc <<aws>> {
        
        rectangle "EKS Cluster - Non-Prod" as eks <<aws>> {
            
            rectangle "**gitlab-agent namespace**" as agent_ns #EDE7F6 {
                component "**GitLab Agent Pod**\n(agentk)" as agent_pod <<agent>>
                component "ServiceAccount" as agent_sa <<k8s>>
                component "ClusterRoleBinding" as crb <<k8s>>
            }
            
            rectangle "**poc-nginx-test namespace**" as app_ns #E3F2FD {
                component "Deployment\n(2 replicas)" as deployment <<k8s>>
                component "Service\n(ClusterIP)" as service <<k8s>>
                component "ConfigMap" as configmap <<k8s>>
                
                rectangle "Pods" as pods_box #FFFFFF {
                    component "nginx pod 1" as pod1 <<k8s>>
                    component "nginx pod 2" as pod2 <<k8s>>
                }
            }
        }
    }
}

' ============================================================================
' LOCAL DEVELOPER
' ============================================================================
actor "Developer" as developer
rectangle "**Local Workspace**\ngitlab-ec/" as local_ws #ECEFF1 {
    file "git clone/push" as git_clone
}

' ============================================================================
' CONNECTIONS
' ============================================================================
' Agent connection to GitLab (CRITICAL: Outbound from cluster)
agent_pod -[#6B4FBB,bold,thickness=2]-> kas : **gRPC/WSS**\n(Outbound)\nFirewall-friendly

' KAS to Agent (responses)  
kas .[#E24329].> agent_pod : CI/CD Commands

' Repo to Agent Config
repo --> agent_config
repo --> ci_file

' Agent executes in cluster
agent_pod -[#326CE5]-> deployment : kubectl apply
agent_pod -[#326CE5]-> service
agent_pod -[#326CE5]-> configmap

' RBAC
agent_sa --> crb
crb --> app_ns : authorized

' Deployment manages pods
deployment --> pod1
deployment --> pod2
service --> pods_box

' Developer workflow
developer --> local_ws
local_ws --> repo : git push

' ============================================================================
' NOTES
' ============================================================================
note top of kas
    **Key Feature:**
    Agent initiates outbound
    connection - no inbound
    firewall rules needed!
end note

note bottom of agent_pod
    **Security:**
    • Token-based auth
    • Namespace-scoped RBAC
    • Outbound-only connection
end note

footer \n**POC Status:** Ready | **Created:** 2026-01-21
@enduml
