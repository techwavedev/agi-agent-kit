name: Adapt Extended Skills

on:
  repository_dispatch:
    types: [skills-updated]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  adapt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Clone awesome-skills fork
        run: git clone --depth 1 https://github.com/techwavedev/antigravity-awesome-skills.git .tmp/antigravity-awesome-skills

      - name: Run adaptation script
        run: |
          python3 scripts/adapt_extended_skills.py \
            --source .tmp/antigravity-awesome-skills/skills \
            --report .tmp/adaptation_report.json

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain templates/skills/extended/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            NEW=$(python3 -c "import json; r=json.load(open('.tmp/adaptation_report.json')); print(len(r['new_skills']))")
            UPDATED=$(python3 -c "import json; r=json.load(open('.tmp/adaptation_report.json')); print(len(r['updated_skills']))")
            echo "summary=New: $NEW | Updated: $UPDATED" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "feat: Update extended skills from upstream"
          branch: auto/update-extended-skills
          commit-message: "feat: update extended skills from upstream sync"
          body: |
            ## Automated Skill Adaptation

            This PR was automatically generated by the skill adaptation pipeline.

            **Summary:** ${{ steps.changes.outputs.summary }}

            **Source:** [antigravity-awesome-skills](https://github.com/sickn33/antigravity-awesome-skills)

            ### Changes
            - New skills copied and adapted with AGI framework integration
            - Updated skills merged with preserved AGI-specific sections

            ### Review Checklist
            - [ ] Spot-check 2-3 new SKILL.md files for correct adaptation
            - [ ] Verify no core/knowledge skills were duplicated
            - [ ] Run `node -c bin/init.js` to validate installer syntax
          labels: automated, skills, extended-tier
          delete-branch: true
