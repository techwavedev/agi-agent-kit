name: Publish to NPM

on:
  release:
    types: [published]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # RELEASE GATE â€” set RELEASE_BLOCKED=true in repo Settings â†’
  # Actions â†’ Variables to hard-block any publish until QA is done.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Check release block flag
        env:
          RELEASE_BLOCKED: ${{ vars.RELEASE_BLOCKED }}
        run: |
          if [ "${RELEASE_BLOCKED}" = "true" ]; then
            echo "ğŸš« Release is currently BLOCKED."
            echo "To unblock: set RELEASE_BLOCKED=false in repo Settings â†’ Actions â†’ Variables."
            exit 1
          fi
          echo "âœ… Release gate: OPEN"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # VIRUS SCAN â€” must pass before publish is allowed
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  virus-scan:
    runs-on: ubuntu-latest
    needs: release-gate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Pack tarball for scanning
        run: npm pack --dry-run 2>&1 | tail -20

      - name: Scan with ClamAV
        run: |
          sudo apt-get install -y clamav > /dev/null 2>&1
          sudo freshclam --quiet 2>/dev/null || true
          npm pack
          TARBALL=$(ls *.tgz)
          mkdir -p /tmp/scan-dir
          tar -xzf "$TARBALL" -C /tmp/scan-dir
          clamscan --recursive --infected --remove=no /tmp/scan-dir \
            && echo "âœ… No threats detected in $TARBALL" \
            || (echo "âŒ Virus scan failed â€” aborting publish" && exit 1)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # INTEGRATION SMOKE TEST
  # Runs the init wizard non-interactively. CI always skips memory
  # (no Qdrant/Ollama available) â€” verifies files are installed.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  integration-test:
    runs-on: ubuntu-latest
    needs: release-gate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install package locally
        run: npm install --no-save .

      - name: Smoke test â€” core install, memory skipped
        run: |
          mkdir -p /tmp/agi-test-core
          # Wizard prompts (new install â€” no existing-install prompt):
          #   1. Install scope  â†’ "" (default: project)
          #   2. Pack           â†’ "1" (core)
          #   3. Memory?        â†’ "2" (skip â€” no Qdrant/Ollama in CI)
          #   4. Agent Teams?   â†’ "2" (skip â€” no Claude Code in CI)
          printf '\n1\n2\n2\n' | node bin/init.js init --path=/tmp/agi-test-core --no-symlinks
          grep "MEMORY_ENABLED=false" /tmp/agi-test-core/.env \
            && echo "âœ… MEMORY_ENABLED=false confirmed in .env" \
            || (echo "âŒ MEMORY_ENABLED=false not found in .env" && exit 1)
          test -f /tmp/agi-test-core/AGENTS.md \
            && echo "âœ… AGENTS.md installed" \
            || (echo "âŒ AGENTS.md missing" && exit 1)
          test -d /tmp/agi-test-core/skills \
            && echo "âœ… skills/ directory present" \
            || (echo "âŒ skills/ directory missing" && exit 1)

      - name: Smoke test â€” medium pack, memory skipped
        run: |
          mkdir -p /tmp/agi-test-medium
          # Pack "2" = medium, memory skip, teams skip
          printf '\n2\n2\n2\n' | node bin/init.js init --path=/tmp/agi-test-medium --no-symlinks
          test -f /tmp/agi-test-medium/AGENTS.md \
            && echo "âœ… Medium pack installed" \
            || (echo "âŒ AGENTS.md missing in medium install" && exit 1)

      - name: Smoke test â€” global install flag
        run: |
          mkdir -p /tmp/agi-test-global
          # --global skips scope prompt. Pack=1, memory=skip, teams=skip
          printf '1\n2\n2\n' | node bin/init.js init --path=/tmp/agi-test-global --global --no-symlinks || true
          echo "âœ… Global flag smoke test complete"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PUBLISH â€” only runs after BOTH virus-scan AND integration-test pass
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish:
    runs-on: ubuntu-latest
    needs: [virus-scan, integration-test]
    environment: npm
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Verify version matches release tag
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch: package.json=$PACKAGE_VERSION, tag=$TAG_VERSION"
            exit 1
          fi
          echo "âœ… Version match: $PACKAGE_VERSION"

      - name: Publish to NPM with provenance
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
